name: Packer Validate on PR

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Packer
      uses: hashicorp/setup-packer@v1
      with:
        version: '1.11.2'  # Specify the version you need

    - name: Initialize Packer
      run: packer init aws.pkr.hcl

    - name: Run packer fmt
      id: packer_fmt
      run: |
        packer fmt -diff -check aws.pkr.hcl
      continue-on-error: true

    - name: Fail if packer fmt modifies files
      if: steps.packer_fmt.outcome == 'failure'
      run: |
        echo "Packer fmt modified files. Please run 'packer fmt' locally and commit the changes."
        exit 1

    - name: Validate Packer template
      run: |
        packer validate aws.pkr.hcl
